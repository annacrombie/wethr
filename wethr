#!/bin/sh


default_params="units=si&lang=en&extend=hourly&exclude=currently,daily,alerts,flags"
params=${WETHR_PARAMS:-"$default_params"}
api_base="https://api.darksky.net/forecast"
endpoint="${api_base}/${DARKSKY_API_KEY}/${COORDS}?$params"

die() {
  echo "$@" >&2
  exit 1
}

next_color() {
  case $(($1%5)) in
    0) color="34 l";;
    1) color="35 m";;
    2) color="36 c";;
    3) color="37 w";;
    4) color="33 y";;
  esac
}

data_source() {
  case $1 in
    a) ds="apparentTemperature";;
    B) ds="windBearing";;
    c) ds="cloudCover*100";;
    d) ds="dewPoint";;
    G) ds="windGust";;
    h) ds="humidity*100";;
    I) ds="precipIntensity";;
    o) ds="ozone";;
    p) ds="precipProbability*100";;
    r) ds="pressure";;
    t) ds="temperature";;
    u) ds="uvIndex";;
    v) ds="visibility";;
    w) ds="windSpeed";;
    *) ds="";;
  esac
}

fetch_weather() {
  data_dir="$data_dir/$COORDS"
  mkdir -p "$data_dir"

  last_fetch=0
  [[ -f "$data_dir/metadata" ]] && source "$data_dir/metadata"

  ctime="$(date +%s)"

  if [[ $force_fetch ]] || [[ ! -f "$data_dir/src" ]] \
    || [[ $((ctime - last_fetch)) -gt 3600 ]]
  then
    [[ ! -n $COORDS ]] && die "please set COORDS"
    [[ ! -n $DARKSKY_API_KEY ]] && die "please set DARKSKY_API_KEY"

    curl --compressed -sS "$endpoint" > "$data_dir/src" \
      || [[ -f "$data_dir/src" ]] \
      || die "couldn't download data"

    [[ -d "$data_dir/derived" ]] && rm -r "$data_dir/derived"
    mkdir -p "$data_dir/derived"

    initial_date=$(jq '.hourly.data[0].time' "$data_dir/src")
    hour_offset=$(((($initial_date/3600)+9)%24))

    cat > "$data_dir/metadata" <<EOF
last_fetch=$ctime
human_date='$(date)'
hour_offset=$hour_offset
EOF
  fi

  source "$data_dir/metadata"
}

print_usage() {
  printf "
usage: wethr [-h|[-r][-d <data> [-d <data>[...]]][-p <plot args>]]

data:
\e[1;4;36ma\e[0mpparentTemperature
wind\e[1;4;36mB\e[0mearing
\e[1;4;36mc\e[0mloudCover*100
\e[1;4;36md\e[0mewPoint
wind\e[1;4;36mG\e[0must
\e[1;4;36mh\e[0mumidity*100
precip\e[1;4;36mI\e[0mntensity
\e[1;4;36mo\e[0mzone
\e[1;4;36mp\e[0mrecipProbability*100
p\e[1;4;36mr\e[0messure
\e[1;4;36mt\e[0memperature
\e[1;4;36mu\e[0mvIndex
\e[1;4;36mv\e[0misibility
\e[1;4;36mw\e[0mindSpeed

environment
COORDS - lattitude,longitude
  coordinates to fetch the weather for
DARKSKY_API_KEY - xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  your api key

ex.
wethr -dt -da
"
}

force_fetch=""
data=""
plot_args=""
data_dir="${XDG_DATA_HOME:-$HOME/.local/share}/wethr2"
mkdir -p "$data_dir" || die "failed to create data directory"

while getopts "hp:d:f" opt; do
  case $opt in
    p)
      plot_args="$OPTARG"
      ;;
    d)
      data_source "$OPTARG"
      data="$ds $data"
      ;;
    f)
      force_fetch=1
      ;;
    h)
      print_usage
      exit
      ;;
    ?)
      print_usage
      exit 1
      ;;
  esac
done

fetch_weather

data=${data:-temperature}

echo "last fetched: $human_date"
plot_data=""
i=0
for d in $data; do
  next_color $i

  printf "\e[%sm$d\e[0m " ${color% *}

  f="$data_dir/derived/$d"

  [[ -f "$f" ]] || jq -Mr ".hourly.data[] | .$d" "$data_dir/src" > "$f"

  plot_data="-c ${color#* } -i $f $plot_data"
  i=$((i+1))
done

echo

plot -x 4:$hour_offset:24:l $plot_args $plot_data
