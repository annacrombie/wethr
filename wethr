#!/bin/sh


default_params="units=si&lang=en&extend=hourly&exclude=currently,daily,alerts,flags"
params=${WETHR_PARAMS:-"$default_params"}
api_base="https://api.darksky.net/forecast"
endpoint="${api_base}/${DARKSKY_API_KEY}/${COORDS}?$params"

die() {
  echo "$@" >&2
  exit 1
}

next_color() {
  case $(($1%5)) in
    0) color="34 l";;
    1) color="35 m";;
    2) color="36 c";;
    3) color="37 g";;
    4) color="38 w";;
  esac
}

data_source() {
  case $1 in
    a) ds="apparentTemperature";;
    b) ds="windBearing";;
    c) ds="cloudCover*100";;
    d) ds="dewPoint";;
    g) ds="windGust";;
    h) ds="humidity*100";;
    i) ds="precipIntensity";;
    o) ds="ozone";;
    p) ds="precipProbability*100";;
    P) ds="pressure";;
    t) ds="temperature";;
    u) ds="uvIndex";;
    v) ds="visibility";;
    w) ds="windSpeed";;
    *) ds="";;
  esac
}

fetch_weather() {
  data_dir="$data_dir/$COORDS"
  mkdir -p "$data_dir"

  last_fetch=0
  [[ -f "$data_dir/metadata" ]] && source "$data_dir/metadata"

  ctime="$(date +%s)"

  if [[ ! -f "$data_dir/src" ]] || [[ $((ctime - last_fetch)) -gt 3600 ]]; then
    [[ -f "$data_dir/src" ]] && rm "$data_dir/"*

    [[ ! -n $COORDS ]] && die "please set COORDS"
    [[ ! -n $DARKSKY_API_KEY ]] && die "please set DARKSKY_API_KEY"

    curl -sS "$endpoint" > "$data_dir/src" \
      || [[ -f "$data_dir/src" ]] \
      || die "couldn't download data"

    initial_date=$(jq '.hourly.data[0].time' "$data_dir/src")
    hour_offset=$(((($initial_date/3600)+9)%24))

    cat > "$data_dir/metadata" <<EOF
last_fetch=$ctime
human_date='$(date)'
hour_offset=$hour_offset
EOF
  fi

  source "$data_dir/metadata"
}

print_usage() {
  cat <<EOF
usage: wethr [-h|[-d <data> [-d <data>[...]]] [-p <plot args>]

data:
a - apparentTemperature
b - windBearing
c - cloudCover*100
d - dewPoint
g - windGust
h - humidity*100
i - precipIntensity
o - ozone
p - precipProbability*100
P - pressure
t - temperature
u - uvIndex
v - visibility
w - windSpeed

environment
COORDS - lattitude,longitude
  coordinates to fetch the weather for
DARKSKY_API_KEY - xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  your api key

ex.
wethr -dt -da
EOF
}

data=""
plot_args=""
data_dir="${XDG_DATA_HOME:-$HOME/.local/share}/wethr2"
mkdir -p "$data_dir" || die "failed to create data directory"

while getopts "hp:d:" opt; do
  case $opt in
    p)
      plot_args="$OPTARG"
      ;;
    d)
      data_source "$OPTARG"
      data="$ds $data"
      ;;
    h)
      print_usage
      exit
      ;;
    ?)
      print_usage
      exit 1
      ;;
  esac
done

fetch_weather

data=${data:-temperature}

echo "last fetched: $human_date"
plot_data=""
i=0
for d in $data; do
  next_color $i

  printf "\e[%sm$d\e[0m " ${color% *}

  f="$data_dir/$d"

  if [[ ! -f "$data_dir/$d" ]]; then
    jq -Mr ".hourly.data[] | .$d" "$data_dir/src" > "$data_dir/$d"
  fi

  plot_data="-c ${color#* } -i $f $plot_data"
  i=$((i+1))
done

echo

plot -x 4:$hour_offset:24:l $plot_args $plot_data
